library(testthat)
library(nlmixr)

context("UI-NLME01: one-compartment bolus, single-dose")

if (identical(Sys.getenv("NLMIXR_VALIDATION_FULL"), "true")) {
    test_that("Closed-form", {

        datr <- Bolus_1CPT
        datr$EVID <- ifelse(datr$EVID == 1, 101, datr$EVID)
        datr <- datr[datr$EVID != 2, ]

        uif <- function(){
            ini({
                lCl <- 1.6
                lV <- 4.5
                prop.err <- 0.1
                eta.V ~ 0.1
                eta.Cl ~ 0.1
            })
            model({
                v <- exp(lV + eta.V)
                cl <- exp(lCl + eta.Cl)
                linCmt() ~ prop(prop.err)
            })
        }

        runno <- "N001"

        dat <- datr[datr$SD == 1, ]

        fit <- nlmixr(uif, dat, est="nlme")

        z <- summary(as.nlme(fit))

        expect_equal(signif(as.numeric(as.nlme(fit)$logLik), 6),-12119.4)
        expect_equal(signif(AIC(as.nlme(fit)), 6), 24248.8)
        expect_equal(signif(BIC(as.nlme(fit)), 6), 24277.4)

        expect_equal(signif(AIC(fit), 6), 20083.5)
        expect_equal(signif(BIC(fit), 6), 20112.1)

        expect_equal(signif(as.numeric(as.nlme(fit)$coefficients$fixed[1]), 3), 1.36)
        expect_equal(signif(as.numeric(as.nlme(fit)$coefficients$fixed[2]), 3), 4.20)

        expect_equal(signif(fit$theta, 3), structure(c(1.36, 4.2, 0.199), .Names = c("lCl", "lV", "prop.err")));

        expect_equal(signif(fit$omega, 3), structure(c(0.0916908, 0, 0, 0.0713987), .Dim = c(2L, 2L), .Dimnames = list(NULL, NULL)));

        ## ID1 and ID2 reversed, but the same value (compared with nlme test)
        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[2], 3)), 0.267)
        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[1], 3)), 0.303)
        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[3], 3)), 0.199)

        expect_equal(signif(random.effects(fit),3), structure(list(ID = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12,   13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28,   29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44,   45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60,   61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76,   77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92,   93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106,   107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119,   120), eta.V = c(-0.152, -0.129, 0.0267, 0.144, -0.191, -0.152,   -0.07, 0.232, -0.202, 0.127, -0.115, -0.268, 0.0888, 0.0699,   0.332, -0.435, 0.191, -0.0438, 0.0584, 0.223, 0.654, 0.0942,   -0.233, -0.494, 0.212, 0.0121, 0.176, -0.17, -0.202, 0.0865,   -0.138, 0.0174, -0.383, 0.325, 0.57, -0.324, -0.197, -0.186,   0.0203, 0.525, 0.0951, 0.163, -0.062, 0.531, -0.551, 0.596, 0.0149,   0.295, -0.141, -0.0708, 0.0247, 0.554, -0.291, -0.429, -0.278,   0.0335, -0.00104, 0.0138, -0.339, -0.489, 0.0948, -0.281, -0.386,   0.185, 0.322, -0.116, -0.327, -0.43, -0.709, 0.291, 0.154, -0.187,   -0.0389, -0.075, -0.156, -0.115, -0.122, -0.0461, -0.178, -0.00479,   -0.286, 0.324, 0.63, 0.668, 0.233, -0.231, 0.0875, -0.102, 0.111,   0.225, -0.766, 0.119, -0.723, 0.0838, 0.36, 0.163, -0.144, -0.333,   0.282, -0.144, 0.163, 0.201, -0.25, 0.312, 0.31, -0.0946, 0.063,   0.343, -0.135, 0.301, -0.186, -0.453, 0.618, 0.514, 0.262, -0.0604,   -0.0923, 0.0565, -0.323, 0.251), eta.Cl = c(-0.0128, -0.289,   -0.0509, -0.195, -0.126, 0.167, -0.042, -0.388, 0.444, 0.566,   0.0337, 0.432, 0.109, 0.427, -0.086, 0.192, -0.0621, 0.133, 0.0101,   -0.236, 0.314, -0.109, -0.457, -0.175, 0.186, -0.112, -0.152,   -0.211, 0.0268, 0.0498, 0.198, -0.107, -0.359, -0.274, -0.374,   -0.121, 0.293, 0.443, 0.201, -0.092, -0.114, 0.241, -0.242, -0.219,   -0.0663, 0.349, -0.303, 0.3, -0.176, 0.398, -0.0752, -0.2, -0.252,   0.169, -0.0473, -0.583, -0.00897, -0.0823, -0.0813, -0.0735,   0.703, 0.114, -0.384, 0.0322, -0.212, 0.0561, -0.499, -0.285,   -0.312, 0.219, -0.378, 0.112, -0.582, -0.108, 0.0226, -0.143,   -0.173, -0.106, 0.539, 0.194, -0.648, -0.0106, 0.174, 0.369,   0.0241, -0.175, -0.0993, 0.0741, 0.25, -0.414, -0.0412, 0.085,   -0.00592, -0.189, -0.509, 0.0103, 0.37, 0.128, 0.29, -0.0205,   0.17, 0.0544, -0.0028, -0.0854, 0.142, 0.188, 0.195, 0.234, 0.486,   0.338, 0.0466, 0.291, -0.24, -0.0559, 0.186, 0.32, -0.0837, 0.373,   0.157, -0.313)), .Names = c("ID", "eta.V", "eta.Cl"), row.names = c(NA,   -120L), class = "data.frame"))

        expect_equal(signif(random.effects(as.nlme(fit)), 3), structure(list(eta.V = c(0.654, 0.525, 0.63, 0.31, 0.262, 0.127, 0.233, 0.251, 0.282, 0.0948, 0.191, 0.201, 0.111, -0.00104, 0.176, 0.0149, -0.0708, 0.0951, -0.0389, -0.186, -0.17, -0.075, -0.07, -0.135, -0.129, -0.429, -0.435, 0.668, -0.723, -0.327, -0.709, 0.618, 0.212, 0.154, 0.36, 0.163, 0.163, 0.0699, 0.0247, 0.163, -0.0438, -0.144, 0.0138, 0.0335, -0.0946, -0.138, 0.554, -0.116, -0.115, 0.144, -0.197, -0.062, 0.0888, -0.152, 0.531, -0.122, 0.332, 0.324, -0.286, 0.514, -0.186, 0.325, 0.343, -0.323, 0.322, -0.494, -0.00479, -0.386, -0.383, 0.0838, 0.0942, 0.0865, -0.0461, 0.223, 0.0174, -0.0604, 0.185, 0.063, 0.0267, 0.0875, 0.57, -0.281, -0.25, -0.152, -0.268, 0.596, -0.144, -0.291, 0.295, -0.43, 0.225, 0.301, 0.291, 0.312, -0.551, -0.324, 0.232, 0.0203, 0.0121, 0.0565, -0.102, -0.0923, 0.0584, -0.766, 0.119, -0.178, -0.202, -0.156, -0.333, -0.115, -0.231, -0.141, -0.233, -0.187, -0.278, -0.202, -0.489, -0.339, -0.191, -0.453), eta.Cl = c(0.314, -0.092, 0.174, 0.142, 0.186, 0.566, 0.0241, -0.313, 0.29, 0.703, -0.0621, 0.0544, 0.25, -0.00897, -0.152, -0.303, 0.398, -0.114, -0.582, 0.443, -0.211, -0.108, -0.042, 0.486, -0.289, 0.169, 0.192, 0.369, -0.00592, -0.499, -0.312, -0.24, 0.186, -0.378, -0.509, 0.241, 0.0103, 0.427, -0.0752, 0.17, 0.133, 0.37, -0.0823, -0.583, 0.188, 0.198, -0.2, 0.0561, -0.143, -0.195, 0.293, -0.242, 0.109, 0.167, -0.219, -0.173, -0.086, -0.0106, -0.648, -0.0559, 0.0466, -0.274, 0.234, 0.157, -0.212, -0.175, 0.194, -0.384, -0.359, -0.189, -0.109, 0.0498, -0.106, -0.236, -0.107, 0.32, 0.0322, 0.195, -0.0509, -0.0993, -0.374, 0.114, -0.0028, -0.0128, 0.432, 0.349, -0.0205, -0.252, 0.3, -0.285, -0.414, 0.338, 0.219, -0.0854, -0.0663, -0.121, -0.388, 0.201, -0.112, 0.373, 0.0741, -0.0837, 0.0101, -0.0412, 0.085, 0.539, 0.444, 0.0226, 0.128, 0.0337, -0.175, -0.176, -0.457, 0.112, -0.0473, 0.0268, -0.0735, -0.0813, -0.126, 0.291)), .Names = c("eta.V", "eta.Cl"), row.names = c("21", "40", "83", "105", "115", "10", "85", "120", "99", "61", "17", "102", "89", "57", "27", "47", "50", "41", "73", "38", "28", "74", "7", "109", "2", "54", "16", "84", "93", "67", "69", "113", "25", "71", "95", "42", "96", "14", "51", "101", "18", "97", "58", "56", "106", "31", "52", "66", "76", "4", "37", "43", "13", "6", "44", "77", "15", "82", "81", "114", "111", "34", "108", "119", "65", "24", "80", "63", "33", "94", "22", "30", "78", "20", "32", "116", "64", "107", "3", "87", "35", "62", "103", "1", "12", "46", "100", "53", "48", "68", "90", "110", "70", "104", "45", "36", "8", "39", "26", "118", "88", "117", "19", "91", "92", "79", "9", "75", "98", "11", "86", "49", "23", "72", "55", "29", "60", "59", "5", "112"), effectNames = c("eta.V", "eta.Cl"), label = "Random effects", level = 1L, standardized = FALSE, grpNames = "ID", class = c("ranef.lme", "data.frame")))

        ## Check the ETAs are the same between nlme and focei.
        eta.nlme <- random.effects(as.nlme(fit));
        eta.nlme <- eta.nlme[order(as.numeric(row.names(eta.nlme))), ]

        expect_equal(eta.nlme$eta.V, random.effects(fit)$eta.V);
        expect_equal(eta.nlme$eta.Cl, random.effects(fit)$eta.Cl);

    })

    test_that("ODE", {
        datr <- Bolus_1CPT
        datr$EVID <- ifelse(datr$EVID == 1, 101, datr$EVID)
        datr <- datr[datr$EVID != 2, ]

        runno <- "N001"

        dat <- datr[datr$SD == 1, ]

        uif <- function(){
            ini({
                lCl <- 1.6
                lV <- 4.5
                prop.err <- 0.1
                eta.V ~ 0.1
                eta.Cl ~ 0.1
            })
            model({
                v <- exp(lV + eta.V)
                cl <- exp(lCl + eta.Cl)
                d / dt(centr) = -(cl / v) * centr;
                cp = centr / v;
                cp ~ prop(prop.err)
            })
        }
        fitODE <- as.nlme(nlmixr(uif, dat, est="nlme"))

        z <- summary(fitODE)

        expect_equal(signif(as.numeric(fitODE$logLik), 6),-12119.4)
        expect_equal(signif(AIC(fitODE), 6), 24248.7)
        expect_equal(signif(BIC(fitODE), 6), 24277.4)

        expect_equal(signif(as.numeric(fitODE$coefficients$fixed[1]), 3), 1.36)
        expect_equal(signif(as.numeric(fitODE$coefficients$fixed[2]), 3), 4.20)

        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[1], 3)), 0.267)
        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[2], 3)), 0.303)
        expect_equal(as.numeric(signif(exp(attr(z$apVar, "Pars"))[3], 3)), 0.199)
    })

}
